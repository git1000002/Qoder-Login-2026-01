name: Qoder Login

on:
  workflow_dispatch:
    inputs:
      qoder_token:
        description: 'Qoder Personal Access Token'
        required: true
        type: string
      task_id:
        description: 'Task ID for callback'
        required: true
        type: string
      callback_url:
        description: 'Callback URL after completion'
        required: false
        type: string
        default: 'https://qd.zhmbo.cn/callback'
      os_type:
        description: 'Operating System'
        required: false
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        default: 'ubuntu-latest'

jobs:
  login:
    runs-on: ${{ github.event.inputs.os_type }}
    
    steps:
      - name: System Info
        shell: bash
        run: |
          echo "=== System Information ==="
          echo "OS: $RUNNER_OS"
          echo "Arch: $RUNNER_ARCH"
          echo "Task ID: ${{ github.event.inputs.task_id }}"
          uname -a || systeminfo || true
          
      - name: Install Qoder CLI (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "=== Installing Qoder CLI via curl ==="
          curl -fsSL https://qoder.com/install | bash
          echo 'export PATH="$HOME/.qoder/bin:$PATH"' >> ~/.bashrc
          export PATH="$HOME/.qoder/bin:$PATH"
          which qoder || echo "qoder not in PATH yet"
          
      - name: Install Qoder CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "=== Installing Qoder CLI via npm ==="
          npm install -g @qoder-ai/qodercli
          
      - name: Login with Qoder
        shell: bash
        env:
          QODER_PERSONAL_ACCESS_TOKEN: ${{ github.event.inputs.qoder_token }}
        run: |
          echo "=== Qoder Login ==="
          export PATH="$HOME/.qoder/bin:$PATH"
          
          # 使用环境变量方式登录
          export QODER_PERSONAL_ACCESS_TOKEN="${{ github.event.inputs.qoder_token }}"
          
          # 尝试多种登录方式
          qoder auth login 2>&1 || \
          qoder login 2>&1 || \
          echo "Login command finished"
          
          # 验证登录状态
          qoder auth whoami 2>&1 || qoder whoami 2>&1 || echo "Whoami check done"
          
      - name: Callback Notification
        if: always()
        shell: bash
        run: |
          STATUS="${{ job.status }}"
          TASK_ID="${{ github.event.inputs.task_id }}"
          CALLBACK="${{ github.event.inputs.callback_url }}"
          RUN_ID="${{ github.run_id }}"
          
          echo "=== Sending Callback ==="
          echo "Status: $STATUS, Task: $TASK_ID"
          
          curl -X POST "$CALLBACK" \
            -H "Content-Type: application/json" \
            -d "{\"task_id\":\"$TASK_ID\",\"status\":\"$STATUS\",\"run_id\":\"$RUN_ID\",\"os\":\"$RUNNER_OS\"}" \
            --max-time 10 || echo "Callback sent or failed"