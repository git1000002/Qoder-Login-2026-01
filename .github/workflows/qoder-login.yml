name: Qoder Login

on:
  workflow_dispatch:
    inputs:
      qoder_token:
        description: 'Qoder Personal Access Token'
        required: true
        type: string
      task_id:
        description: 'Task ID for callback'
        required: true
        type: string
      callback_url:
        description: 'Callback URL after completion'
        required: false
        type: string
        default: 'https://tools.zhmbo.cn/api/qoder/callback'
      os_type:
        description: 'Operating System'
        required: false
        type: choice
        options:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        default: 'ubuntu-latest'

jobs:
  login:
    runs-on: ${{ github.event.inputs.os_type }}
    
    steps:
      - name: System Info
        shell: bash
        run: |
          echo "=== System Information ==="
          echo "OS: $RUNNER_OS"
          echo "Arch: $RUNNER_ARCH"
          echo "Task ID: ${{ github.event.inputs.task_id }}"
          uname -a || systeminfo || true
          
      - name: Install Qoder CLI (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "=== Installing Qoder CLI via curl ==="
          curl -fsSL https://qoder.com/install | bash
          echo 'export PATH="$HOME/.qoder/bin:$PATH"' >> ~/.bashrc
          export PATH="$HOME/.qoder/bin:$PATH"
          which qoder || echo "qoder not in PATH yet"
          
      - name: Install Qoder CLI (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "=== Installing Qoder CLI via npm ==="
          npm install -g @qoder-ai/qodercli
          
      - name: Login with Qoder (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        env:
          QODER_PERSONAL_ACCESS_TOKEN: ${{ github.event.inputs.qoder_token }}
        run: |
          echo "=== Qoder Activation ==="
          export PATH="$HOME/.local/bin:$HOME/.qoder/bin:$PATH"
          export QODER_PERSONAL_ACCESS_TOKEN="${{ github.event.inputs.qoder_token }}"
          
          echo "Token set, running qodercli..."
          qodercli --version
          
          echo "Testing API connection..."
          qodercli -p "Say hello in one word" --max-turns 1 2>&1 || echo "API test done"
          
          echo "Extra credit usage..."
          qodercli -p "What is today's date?" --max-turns 1 2>&1 || echo "Extra test done"
          
          echo "Qoder activation completed!"
          
      - name: Login with Qoder (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          QODER_PERSONAL_ACCESS_TOKEN: ${{ github.event.inputs.qoder_token }}
        run: |
          echo "=== Qoder Activation (Windows) ==="
          $env:QODER_PERSONAL_ACCESS_TOKEN = "${{ github.event.inputs.qoder_token }}"
          
          echo "Token set, running qodercli..."
          qodercli --version
          
          echo "Testing API connection..."
          qodercli -p "Say hello in one word" --max-turns 1
          
          echo "Extra credit usage..."
          qodercli -p "What is today's date?" --max-turns 1
          
          echo "Qoder activation completed!"
          
      - name: Callback Notification
        if: always()
        shell: bash
        run: |
          STATUS="${{ job.status }}"
          TASK_ID="${{ github.event.inputs.task_id }}"
          CALLBACK="${{ github.event.inputs.callback_url }}"
          RUN_ID="${{ github.run_id }}"
          
          # 获取运行器公网 IP
          echo "=== Getting Runner IP ==="
          RUNNER_IP=$(curl -s --max-time 5 ifconfig.me || curl -s --max-time 5 icanhazip.com || curl -s --max-time 5 api.ipify.org || echo "unknown")
          echo "Runner IP: $RUNNER_IP"
          
          echo "=== Sending Callback ==="
          echo "Status: $STATUS, Task: $TASK_ID, IP: $RUNNER_IP"
          
          curl -X POST "$CALLBACK" \
            -H "Content-Type: application/json" \
            -d "{\"task_id\":\"$TASK_ID\",\"status\":\"$STATUS\",\"run_id\":\"$RUN_ID\",\"os\":\"$RUNNER_OS\",\"runner_ip\":\"$RUNNER_IP\"}" \
            --max-time 10 || echo "Callback sent or failed"
